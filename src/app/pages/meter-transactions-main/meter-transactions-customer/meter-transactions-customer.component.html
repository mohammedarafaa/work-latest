<section class=" pt-2 mx-auto pt-sm-3 mb-5 pt-md-4  pb-sm-3 pb-md-4 px-2 px-sm-3 px-lg-4">
  <!-- Header and Filter Toggle -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{{ 'Meter_Transactions' | translate }}</h2>
    <button class="btn btn-outline-primary" (click)="toggleFilters()">
      <i class="fas me-2" [class.fa-filter]="!showFilters" [class.fa-filter-slash]="showFilters"></i>
      {{ showFilters ? ('Hide_Filters' | translate) : ('Show_Filters' | translate) }}
      <span class="badge bg-primary ms-2" *ngIf="getActiveFilterCount() > 0">
        {{ getActiveFilterCount() }}
      </span>
    </button>
  </div>

  <!-- Filter Section -->
  <div class="filter-section mb-4 card border-0 shadow-sm" *ngIf="showFilters">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <div>
        <i class="fas fa-sliders-h me-2"></i>
        <span class="fw-bold">{{ 'Advanced_Filters' | translate }}</span>
        <span class="badge bg-secondary ms-2" *ngIf="getActiveFilterCount() > 0">
          {{ getActiveFilterCount() }} {{ 'Active' | translate }}
        </span>
      </div>
      <button class="btn btn-outline-light btn-sm" (click)="toggleFilters()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="card-body">
      <form [formGroup]="filterForm" class="row g-3">
        <!-- Independent Compound Filter -->
        <div class="col-12 col-sm-6 col-lg-4">
          <label class="form-label">{{ 'compound' | translate }}</label>
          <ng-select
            [items]="compoundsList"
            bindValue="id"
            bindLabel="name"
            placeholder="{{ 'Select_Compound' | translate }}"
            formControlName="compoundId"
            [clearable]="true"
          >
            <ng-template ng-label-tmp let-item="item">
              <i class="fas fa-building me-2"></i>{{ item.name }}
            </ng-template>
          </ng-select>
        </div>

        <!-- Independent Property Filter -->
        <div class="col-12 col-sm-6 col-lg-4">
          <label class="form-label">{{ 'Property_Number' | translate }}</label>
          <ng-select
            [items]="propertiesList"
            bindValue="id"
            bindLabel="name"
            placeholder="{{ 'Select_Property' | translate }}"
            formControlName="propertyId"
            [clearable]="true"
          >
            <ng-template ng-label-tmp let-item="item">
              <i class="fas fa-home me-2"></i>{{ item.name }}
              <div class="small text-muted">{{ item.compoundName }}</div>
            </ng-template>
          </ng-select>
        </div>

        <!-- Independent Meter Filter -->
        <div class="col-12 col-sm-6 col-lg-4">
          <label class="form-label">{{ 'Meter' | translate }}</label>
          <ng-select
            [items]="metersList"
            bindValue="id"
            bindLabel="serialNumber"
            placeholder="{{ 'Select_Meter' | translate }}"
            formControlName="meterId"
            [clearable]="true"
          >
            <ng-template ng-label-tmp let-item="item">
              <i class="fas fa-tachometer-alt me-2"></i>{{ item.serialNumber }}
            </ng-template>
          </ng-select>
        </div>

        <!-- Meter Type Filter -->
        <div class="col-12 col-sm-6 col-lg-4">
          <label class="form-label">{{ 'charge.meterType' | translate }}</label>
          <ng-select
            [items]="meterTypes"
            placeholder="{{ 'Select_Type' | translate }}"
            formControlName="meterType"
            [clearable]="true"
          >
            <ng-option value="ELECTRICITY">
              <i class="fas fa-bolt me-2"></i> {{ 'ELECTRICITY' | translate }}
            </ng-option>
            <ng-option value="GAS">
              <i class="fas fa-fire me-2"></i> {{ 'GAS' | translate }}
            </ng-option>
            <ng-option value="WATER">
              <i class="fas fa-tint me-2"></i> {{ 'WATER' | translate }}
            </ng-option>
          </ng-select>
        </div>

        <!-- Date Filters
        <div class="col-12 col-sm-6 col-lg-4">
          <label class="form-label">{{ 'Start_Date' | translate }}</label>
          <input type="date" class="form-control" formControlName="startDate">
        </div>
        <div class="col-12 col-sm-6 col-lg-4">
          <label class="form-label">{{ 'End_Date' | translate }}</label>
          <input type="date" class="form-control" formControlName="endDate">
        </div> -->

        <!-- Filter Actions -->
        <div class="col-12">
          <hr>
          <div class="d-flex justify-content-between">
            <div class="filter-summary">
              <span class="text-muted small" *ngIf="getActiveFilterCount() === 0">
                <i class="fas fa-info-circle me-1"></i>
                {{ 'No_Filters_Applied' | translate }}
              </span>
              <span class="text-primary small fw-semibold" *ngIf="getActiveFilterCount() > 0">
                <i class="fas fa-check-circle me-1"></i>
                {{ getActiveFilterCount() }} {{ 'Filters_Active' | translate }}
              </span>
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-secondary"
                (click)="resetFilters()"
                [disabled]="isLoading || loadingFilters || getActiveFilterCount() === 0">
                <i class="fas fa-undo me-2"></i>
                {{ 'Reset' | translate }}
              </button>
              <button type="button" class="btn btn-primary"
                (click)="applyFilters()"
                [disabled]="isLoading || loadingFilters">
                <i class="fas fa-search me-2"></i>
                {{ 'Apply' | translate }}
                <span *ngIf="isLoading" class="spinner-border spinner-border-sm ms-2"></span>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading && !dataList" class="text-center py-5">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
    <h5>{{ 'Loading' | translate }}...</h5>
  </div>

  <!-- No Data State -->
  <div *ngIf="!isLoading && (!dataList || !dataList.content || dataList.content.length === 0)" class="text-center py-5">
    <i class="fas fa-receipt fa-4x text-muted mb-4"></i>
    <h4>{{ 'No_Transactions_Found' | translate }}</h4>
    <p class="text-muted">
      {{ getActiveFilterCount() > 0 ? ('No_Transactions_Match_Filters' | translate) : ('No_Transactions_Available' | translate) }}
    </p>
    <button class="btn btn-outline-primary" (click)="resetFilters()" *ngIf="getActiveFilterCount() > 0">
      <i class="fas fa-refresh me-2"></i>
      {{ 'Clear_Filters' | translate }}
    </button>
  </div>

  <!-- Transactions Content -->
  <div *ngIf="!isLoading && dataList && dataList.content && dataList.content.length > 0">
    <!-- Page Size and Info -->
    <div class="row align-items-center mb-3">
      <div class="col-12 col-md-6 mb-2 mb-md-0">
        <div class="d-flex align-items-center">
          <label class="form-label me-2 mb-0">{{ 'Items_Per_Page' | translate }}:</label>
          <select class="form-select form-select-sm" [ngModel]="paging.size" (ngModelChange)="onPageSizeChange($event)" style="width: 70px;">
            <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
          </select>
        </div>
      </div>
      <div class="col-12 col-md-6">
        <div class="text-muted small text-md-end">
          {{ 'Showing' | translate }} {{ getStartRecord() }} to {{ getEndRecord() }}
          of {{ getTotalElements() }} {{ 'Entries' | translate }}
        </div>
      </div>
    </div>

    <!-- Desktop Table -->
    <div class="d-none d-md-block">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-primary">
            <tr>
              <th scope="col" *ngFor="let col of listOfColumns" class="sortable-header"
                  (click)="onSort(col)" [title]="getColumnLabel(col) | translate">
                <div class="d-flex justify-content-between align-items-center">
                  {{ getColumnLabel(col) | translate }}
                  <i class="fas ms-2" [ngClass]="getSortIcon(col)"></i>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let tx of dataList.content">
              <td>{{ tx.transactionNumber }}</td>
              <td>{{ tx.meterSerial }}</td>
              <td>{{ tx.amount | currency:'EGP':'symbol':'1.2-2' }}</td>
              <td>{{ tx.amountCharged | currency:'EGP':'symbol':'1.2-2' }}</td>
              <td>
                <span class="badge" [ngClass]="getCurrentStatus(tx.status)?.color">
                  {{ getCurrentStatus(tx.status)?.name | translate }}
                </span>
              </td>
              <td>
                <span class="badge text-white" [ngClass]="getPaymentMethodColor(tx.paymentMethodType)">
                  {{ getPaymentMethodType(tx.paymentMethodType) | translate }}
                </span>
              </td>
              <td>
                <div class="fw-semibold">{{ tx.propertyNo }}</div>
                <small class="text-muted">{{ tx.compoundName }}</small>
              </td>
              <td>
                <span class="badge"
                  [ngClass]="{
                    'bg-warning text-dark': tx.meterType === 'ELECTRICITY',
                    'bg-danger': tx.meterType === 'GAS',
                    'bg-info': tx.meterType === 'WATER'
                  }">
                  <i class="fas me-1"
                    [ngClass]="{
                      'fa-bolt': tx.meterType === 'ELECTRICITY',
                      'fa-fire': tx.meterType === 'GAS',
                      'fa-tint': tx.meterType === 'WATER'
                    }"></i>
                  {{ tx.meterType | translate }}
                </span>
              </td>
              <td>
                <div class="text-nowrap">
                  <div>{{ tx.createdAt | date:'dd/MM/yyyy' }}</div>
                  <small class="text-muted">{{ tx.createdAt | date:'HH:mm' }}</small>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Mobile Cards -->
    <div class="d-block d-md-none">
      <div *ngFor="let tx of dataList.content; let i = index" class="card border-0 shadow-sm mb-3">
        <div class="card-header bg-primary text-white">
          <div class="">
            <div>
              <h6 class="mb-0">{{ 'Transaction' | translate }} #{{ tx.transactionNumber }}</h6>
              <small class="text-white-50">{{ tx.meterSerial }}</small>
            </div>
            <h5 class="badge bg-light text-dark">
              {{ tx.createdAt | date:'dd/MM/yy' }}
            </h5>
          </div>
        </div>
        <div class="card-body">
          <div class="row mb-2">
            <div class="col-6">
              <small class="text-muted">{{ 'Amount' | translate }}</small>
              <div class="fw-bold text-success">{{ tx.amount | currency:'EGP':'symbol':'1.2-2' }}</div>
            </div>
            <div class="col-6">
              <small class="text-muted">{{ 'Amount_Charged' | translate }}</small>
              <div class="fw-bold">{{ tx.amountCharged | currency:'EGP':'symbol':'1.2-2' }}</div>
            </div>
          </div>
          <div class="row mb-2">
            <div class="col-6">
              <small class="text-muted">{{ 'Status' | translate }}</small>
              <span class="badge" [ngClass]="getCurrentStatus(tx.status)?.color">
                {{ getCurrentStatus(tx.status)?.name | translate }}
              </span>
            </div>
            <div class="col-6">
              <small class="text-muted">{{ 'Payment_Method' | translate }}</small>
              <span class="badge text-white" [ngClass]="getPaymentMethodColor(tx.paymentMethodType)">
                {{ getPaymentMethodType(tx.paymentMethodType) | translate }}
              </span>
            </div>
          </div>
          <div class="row mb-2">
            <div class="col-12">
              <small class="text-muted">{{ 'Location' | translate }}</small>
              <div class="fw-medium">{{ tx.propertyNo }} - {{ tx.compoundName }}</div>
            </div>
          </div>
          <div class="row">
            <div class="col-6">
              <small class="text-muted">{{ 'Meter_Type' | translate }}</small>
              <span class="badge"
                [ngClass]="{
                  'bg-warning text-dark': tx.meterType === 'ELECTRICITY',
                  'bg-danger': tx.meterType === 'GAS',
                  'bg-info': tx.meterType === 'WATER'
                }">
                {{ tx.meterType | translate }}
              </span>
            </div>
            <div class="col-6">
              <small class="text-muted">{{ 'Transaction_Date' | translate }}</small>
              <div class="fw-medium">{{ tx.createdAt | date:'M/d/yy, h:mm a' }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination (matches customer dashboard style) -->
    <div class="pt-2 pt-sm-3 pt-md-4" *ngIf="shouldShowPagination()">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-2 gap-md-3">
        <div class="text-muted small text-center text-md-start order-2 order-md-1">
          <span class="d-block d-sm-inline">
            {{ 'Showing' | translate }} {{ getStartRecord() }} to {{ getEndRecord() }}
            of {{ getTotalElements() }} {{ 'Entries' | translate }}
          </span>
        </div>
        <div class="order-1 order-md-2">
          <ngb-pagination
            [collectionSize]="getTotalElements()"
            [(page)]="currentPage"
            [maxSize]="isMobile ? 3 : 5"
            [pageSize]="paging.size"
            (pageChange)="onPageChange($event)"
            [rotate]="true"
            [boundaryLinks]="true"
            size="sm"
            class="mb-0">
          </ngb-pagination>
        </div>
      </div>
    </div>
  </div>
</section>
